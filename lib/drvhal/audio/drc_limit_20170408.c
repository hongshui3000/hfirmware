
#include "AEC_file.h"
#include <math.h>

long drc_limit (unsigned short rt, unsigned short at, unsigned short rt1, unsigned short at1, short xin, short LT, short NT)
{
	static long peak=0;
	static long gain=0x7fff;

	long peak_diff;
	short peak_index;
	short peak_low, peak_high;

	static short peak_table[128] = {0x0016, 0x0017, 0x0019, 0x001a, 0x001c, 0x001d, 0x001f, 0x0021, 
									0x0023, 0x0025, 0x0027, 0x0029, 0x002c, 0x002e, 0x0031, 0x0034, 
									0x0037, 0x003a, 0x003e, 0x0041, 0x0045, 0x0049, 0x004e, 0x0052, 
									0x0057, 0x005c, 0x0062, 0x0068, 0x006e, 0x0074, 0x007b, 0x0082, 
									0x008a, 0x0092, 0x009b, 0x00a4, 0x00ae, 0x00b8, 0x00c3, 0x00cf, 
									0x00db, 0x00e8, 0x00f6, 0x0104, 0x0114, 0x0124, 0x0135, 0x0148, 
									0x015b, 0x0170, 0x0185, 0x019d, 0x01b5, 0x01cf, 0x01ea, 0x0207, 
									0x0226, 0x0247, 0x0269, 0x028e, 0x02b5, 0x02de, 0x0309, 0x0337, 
									0x0368, 0x039c, 0x03d2, 0x040c, 0x044a, 0x048b, 0x04d0, 0x0519, 
									0x0566, 0x05b8, 0x060e, 0x066a, 0x06cc, 0x0733, 0x07a0, 0x0814, 
									0x088e, 0x0910, 0x0999, 0x0a2b, 0x0ac5, 0x0b68, 0x0c15, 0x0ccd, 
									0x0d8f, 0x0e5d, 0x0f36, 0x101d, 0x1112, 0x1215, 0x1327, 0x1449, 
									0x157d, 0x16c3, 0x181c, 0x198a, 0x1b0d, 0x1ca8, 0x1e5b, 0x2027, 
									0x220f, 0x2413, 0x2637, 0x287a, 0x2ae0, 0x2d6b, 0x301b, 0x32f5, 
									0x35fa, 0x392d, 0x3c90, 0x4027, 0x43f4, 0x47fb, 0x4c3f, 0x50c3, 
									0x558c, 0x5a9e, 0x5ffd, 0x65ad, 0x6bb3, 0x7215, 0x78d7, 0x7fff};

	static short gain_table[128] = {0x0016, 0x0017, 0x0018, 0x001a, 0x001b, 0x001d, 0x001f, 0x0020, 
									0x0022, 0x0024, 0x0027, 0x0029, 0x002b, 0x002e, 0x0031, 0x0033, 
									0x0036, 0x003a, 0x003d, 0x0041, 0x0045, 0x0049, 0x004d, 0x0052, 
									0x0056, 0x005b, 0x0061, 0x0067, 0x006d, 0x0073, 0x007a, 0x0081, 
									0x0089, 0x0091, 0x009a, 0x00a3, 0x00ac, 0x00b7, 0x00c1, 0x00cd, 
									0x00d9, 0x00e6, 0x00f3, 0x0102, 0x0111, 0x0121, 0x0132, 0x0145, 
									0x0158, 0x016c, 0x0182, 0x0199, 0x01b1, 0x01ca, 0x01e6, 0x0202, 
									0x0221, 0x0241, 0x0263, 0x0288, 0x02ae, 0x02d7, 0x0302, 0x032f, 
									0x0360, 0x0393, 0x03c9, 0x0402, 0x043f, 0x0480, 0x04c4, 0x050c, 
									0x0559, 0x05aa, 0x0600, 0x065b, 0x06bb, 0x0721, 0x078d, 0x0800, 
									0x0879, 0x08fa, 0x0982, 0x0a12, 0x0aab, 0x0b4d, 0x0bf8, 0x0cae, 
									0x0d6e, 0x0e3a, 0x0f12, 0x0ff6, 0x10e8, 0x11e9, 0x12f9, 0x1418, 
									0x1549, 0x168c, 0x17e2, 0x194c, 0x1acc, 0x1c63, 0x1e11, 0x1fd9, 
									0x21bc, 0x23bc, 0x25da, 0x2818, 0x2a79, 0x2cfd, 0x2fa7, 0x327a, 
									0x3578, 0x38a3, 0x3bfe, 0x3f8c, 0x4350, 0x474d, 0x4b86, 0x5000, 
									0x54be, 0x59c3, 0x5f15, 0x64b7, 0x6aaf, 0x7101, 0x77b3, 0x7ecb};
	
	unsigned short gain_k;
	short gain_index;

	int i;

	/////////////////////////////////////////////
	//peak computation
	/////////////////////////////////////////////
	peak_diff = (long)abs(xin)-peak;

	if(peak_diff<0)
	{
		peak_diff=0;
	}

	peak = ((long)(at*peak_diff) + (long)(peak<<16) - (long)(rt*peak))>>16;

	/////////////////////////////////////////////
	//lookup table
	/////////////////////////////////////////////
	peak_low =0;
	peak_high =127;
	peak_index=63;

	for (i=0;i<7;i++)
	{
		if(peak_table[peak_index]<peak)
		{
			peak_low = peak_index;
			peak_index = (peak_index+peak_high)>>1;
		}
		else
		{
			peak_high = peak_index;
			peak_index = (peak_index+peak_low)>>1;
		}
	}

	/////////////////////////////////////////////
	//gain computation
	/////////////////////////////////////////////
	if(peak_index<LT && peak_index>NT)
	{
		if((LT-peak_index)>48)
		{
			gain_index = 127;
		}
		else
		{
			gain_index = 79+(LT-peak_index);
		}
	}
	else if(peak_index>=LT)
	{
		if(peak_index-LT>79)
			gain_index = 0;
		else
			gain_index = 79-(peak_index-LT);
	}
	else
		gain_index = 0;
		
	if(gain<gain_table[gain_index])
		gain_k=rt1;
	else
		gain_k=at1;

	gain = ((long)(gain<<16) - (long)(gain_k*gain) + (long)(gain_k*gain_table[gain_index]))>>16;

	return gain;
}

void main()
{
	//at=0.125ms, rt=1s

	//44.1KHz
	//unsigned short rt=0x0003;
	//unsigned short at=0x543e;
	//unsigned short rt1=0x0009;
	//unsigned short at1=0xb2af;

	//8KHz
	unsigned short rt =0x0009;
	unsigned short at =0xfcdb;
	unsigned short rt1=0x001b;
	unsigned short at1=0xffff;
	short LT=115; //(115-127)/2=-12dB
	short NT=47;  //(47-127)/2=-40dB

	//int delay = 16;

	long gain;

	int dataLength;
	int i;
	short din;
	short yout;

	 FILE *pfIn;
	 FILE *pfOut;
	 FILE *pfTest;


	RIFF_CHUNK header1;
	FMT_CHUNK format1;
	DATA_CHUNK data1;

	if ( ( ( pfIn = fopen( "FESignal8k.wav", "rb" ) ) == NULL ))
	{
		printf( "Can't open the source file!" );
		return;
	}

	pfOut = fopen( "drc_out.wav", "wb+" );

	ReadWaveHeader( pfIn, &header1, &format1, &data1 );

	dataLength = data1.uSize / format1.xBlockAlign;

	for ( i = 0; i < dataLength; i++ )
    {
        fread( &din, sizeof(short), 1, pfIn);
		gain = drc_limit(rt,at,rt1,at1,din,LT,NT);
		yout = (din*gain)>>11;

	    fwrite( &yout, sizeof(short), 1, pfOut );
    }

    fclose( pfOut );

	printf("This job is done!\n");

    getchar();
}